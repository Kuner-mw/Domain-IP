name: 定期获取域名IP

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0 点执行

jobs:
  lookup-ips:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 dig 工具
        run: sudo apt-get update && sudo apt-get install -y dnsutils

      - name: 查询 IP 并生成 hosts 文件
        run: |
          INPUT_FILE="domains.txt"
          OUTPUT_FILE="hosts_results.txt"

          echo "# GitHub 相关域名最新 IP 地址 (Hosts 格式)" > $OUTPUT_FILE
          echo "# 最后更新于: $(date -u)" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE

          is_ipv4() {
            [[ "$1" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]
          }

          resolve_ip() {
            local domain="$1"
            local try=0
            local max_try=5
            while (( try < max_try )); do
              local ips
              ips=$(dig +short A "$domain" | sort -u)
              if [[ -n "$ips" ]]; then
                for ip in $ips; do
                  if is_ipv4 "$ip"; then
                    echo "$ip"
                    return 0
                  fi
                done
              fi
              local cname
              cname=$(dig +short CNAME "$domain" | head -n1 | tr -d '\r' | xargs)
              if [[ -n "$cname" ]]; then
                cname=${cname%.}
                domain="$cname"
                ((try++))
                continue
              fi
              break
            done
            return 1
          }

          while IFS= read -r domain || [[ -n "$domain" ]]; do
            domain=$(echo "$domain" | tr -d '\r' | xargs)
            # 跳过空行、注释行、或包含不合法字符的行（整行只允许 a-zA-Z0-9.-）
            if [[ -z "$domain" || "$domain" =~ ^# || ! "$domain" =~ ^[a-zA-Z0-9.-]+$ ]]; then
              continue
            fi
            clean_domain=${domain%.}
            echo "查询中: $clean_domain"

            ip=$(resolve_ip "$clean_domain")
            if [[ -n "$ip" ]]; then
              echo "$ip $clean_domain" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
            fi
          done < "$INPUT_FILE"

      - name: 提交并推送结果
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'
          git add hosts_results.txt

          if ! git diff --cached --quiet; then
            git commit -m "自动更新域名IP地址列表"
            git push
          else
            echo "无变化，无需提交"
