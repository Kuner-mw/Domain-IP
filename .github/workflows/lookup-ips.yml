name: 定期获取域名IP

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0 点执行

jobs:
  lookup-ips:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 dig 工具
        run: sudo apt-get update && sudo apt-get install -y dnsutils

      - name: 查询 IP 并生成 hosts 文件
        run: |
          INPUT_FILE="domains.txt"
          OUTPUT_FILE="hosts_results.txt"

          echo "# GitHub 相关域名最新 IP 地址 (Hosts 格式)" > $OUTPUT_FILE
          echo "# 最后更新于: $(date -u)" >> $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE

          while IFS= read -r domain || [[ -n "$domain" ]]; do
            # 清除行尾可能的空白符和回车符
            domain=$(echo "$domain" | tr -d '\r' | xargs)

            # 跳过空行、以 # 开头的注释行、或者包含非法字符（非数字字母点和横线的）
            if [[ -z "$domain" || "$domain" =~ ^# || "$domain" =~ [^a-zA-Z0-9.-] ]]; then
              continue
            fi

            # 去除尾部句点（FQDN格式中的尾点）
            clean_domain=${domain%.}

            echo "查询中: $clean_domain"

            ips=$(dig +short A "$clean_domain" | sort -u | tr '\n' ' ' | sed 's/ *$//')

            if [[ -n "$ips" ]]; then
              for ip in $ips; do
                echo "$ip $clean_domain" >> $OUTPUT_FILE
              done
              echo "" >> $OUTPUT_FILE
            fi
          done < "$INPUT_FILE"

      - name: 提交并推送结果
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions-bot@users.noreply.github.com'
          git add hosts_results.txt

          if ! git diff --cached --quiet; then
            git commit -m "自动更新域名IP地址列表"
            git push
          else
            echo "无变化，无需提交"
          fi
